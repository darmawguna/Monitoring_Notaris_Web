name: Deploy to VPS

on:
  push:
    branches: ["main"] # Pemicu sekarang hanya 'push'

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 2607
          script: |
            set -e
            cd /home/projectdarma/Monitoring_Notaris_Web

            echo "ğŸ”„ Menarik kode terbaru dari branch main..."
            git pull origin main

            echo "ğŸ—ï¸ Membangun ulang image Docker di server (ini mungkin memakan waktu)..."
            # --no-cache memastikan semua langkah 'RUN' di Dockerfile dijalankan
            # --remove-orphans membersihkan kontainer lama
            docker compose up -d --build --no-cache --remove-orphans

            echo "ğŸ”§ Menjalankan migrasi database..."
            docker compose exec -T app php artisan migrate --force
            
            echo "ğŸ”— Memastikan symbolic link storage..."
            docker compose exec -T app php artisan storage:link

            echo "ğŸ” Memuat ulang Caddy..."
            sudo systemctl reload caddy

            echo "ğŸ—‘ï¸ Membersihkan image Docker yang tidak terpakai..."
            docker image prune -f

            echo "âœ… Deploy berhasil!"