name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy Laravel to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 2607  # sesuaikan jika berbeda
          script: |
            set -e

            PROJECT_DIR="/home/projectdarma/Monitoring_Notaris_Web"
            cd "$PROJECT_DIR"

            echo "ğŸ”„ Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ“¦ Building and pulling Docker images..."
            docker compose build --pull --no-cache
            docker compose down --remove-orphans

            echo "ğŸš€ Starting services..."
            docker compose up -d

            echo "â³ Waiting for app to be ready..."
            sleep 10

            echo "ğŸ”§ Running database migrations..."
            docker compose exec -T app php artisan migrate --force

            echo "ğŸ§¹ Clearing and optimizing cache..."
            docker compose exec -T app php artisan optimize:clear
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache
            docker compose exec -T app php artisan view:cache

            echo "ğŸ”— Ensuring storage link..."
            docker compose exec -T app php artisan storage:link

            echo "ğŸ” Reloading Caddy..."
            sudo systemctl reload caddy

            echo "âœ… Deployment completed successfully!"